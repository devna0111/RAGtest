{% extends "base.html" %}
{% block title %}íŒŒì¼ ì—…ë¡œë“œ | 2ì°¨í”„ë¡œì íŠ¸{% endblock %}

{% block content %}
<h2>ğŸ“ íŒŒì¼ ì—…ë¡œë“œ</h2>
<p>ë¶„ì„í•  doc, ppt, pdf, xlsx, png íŒŒì¼ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</p>

<form id="uploadForm" enctype="multipart/form-data" style="margin-top:1.4rem;">
    <input type="file" name="file" required>
    <button type="submit" style="margin-left:1rem; padding:0.4em 1.3em;">ì—…ë¡œë“œ</button>
</form>

<!-- ì§„í–‰ë¥  í‘œì‹œ -->
<div id="progressBox" style="display:none; margin-top:1.5rem;">
    <progress id="progressBar" max="100" value="0" style="width:80%"></progress>
    <span id="progressText">0%</span>
</div>

<!-- ì—…ë¡œë“œ ê²°ê³¼/ì˜¤ë¥˜/ì„±ê³µ ë©”ì‹œì§€ -->
<div id="resultBox"></div>

<script>
document.getElementById('uploadForm').onsubmit = function(e) {
    e.preventDefault();
    var formData = new FormData(this);

    // ì§„í–‰ë¥  UI
    document.getElementById('progressBox').style.display = 'block';
    document.getElementById('progressBar').value = 0;
    document.getElementById('progressText').innerText = "0%";
    document.getElementById('resultBox').innerHTML = "";

    // AJAX íŒŒì¼ ì—…ë¡œë“œ
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "{{ url_for('upload') }}", true);

    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            var percent = Math.round((e.loaded / e.total) * 100 * 0.7); // ì—…ë¡œë“œëŠ” 0~70%
            document.getElementById('progressBar').value = percent;
            document.getElementById('progressText').innerText = percent + "% (ì—…ë¡œë“œì¤‘)";
        }
    };

    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            document.getElementById('progressBar').value = 80;
            document.getElementById('progressText').innerText = "80% (ë¶„ì„ì¤‘)";
            if (xhr.status == 200) {
                // ê²°ê³¼
                var resp = JSON.parse(xhr.responseText);
                document.getElementById('progressBar').value = 100;
                document.getElementById('progressText').innerText = "100% (ì™„ë£Œ)";
                showResult(resp);
            } else {
                document.getElementById('resultBox').innerHTML = "<div style='color:red;'>âŒ ì—…ë¡œë“œ/ë¶„ì„ ì‹¤íŒ¨</div>";
            }
        }
    };

    xhr.send(formData);
    return false;
};

// chunk ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
function showResult(resp) {
    let html = "";
    if(resp.filename) {
        html += `<div style="margin-top:2rem;"><strong>âœ… ì—…ë¡œë“œ ì„±ê³µ:</strong> ${resp.filename}</div>`;
    }
    if(resp.error) {
        html += `<div style="margin-top:1.5rem; color:red;">${resp.error}</div>`;
    }
    if(resp.chunks && resp.chunks.length > 0) {
        html += `<div style="margin-top:2rem;"><h3>ğŸ“„ ì¶”ì¶œëœ ì²­í¬</h3>
        <div style="background:#fff9ef; padding:1.2rem; border-radius:10px;">`;
        for(let chunk of resp.chunks) {
            html += `<div style="margin-bottom:1.2rem; padding:0.8rem; border-bottom:1px solid #e0d3b4;">
                <strong>Type:</strong> ${chunk.type}<br>
                <strong>Content:</strong>
                <pre style="white-space:pre-wrap;">${chunk.content}</pre>
            </div>`;
        }
        html += `</div></div>`;
    }
    document.getElementById('resultBox').innerHTML = html;
}
</script>
{% endblock %}
